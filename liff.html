<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงทะเบียนผู้ใช้งาน</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.all.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --primary-green: #1e7e34;
            --secondary-green: #218838;
            --primary-yellow: #ffc107;
        }
        body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
        .bg-primary-green { background-color: var(--primary-green); }
        .text-primary-green { color: var(--primary-green); }
        .form-container { border-top: 4px solid var(--primary-green); }
        .btn-submit { background-color: var(--primary-green); }
        .btn-submit:hover { background-color: var(--secondary-green); }
        .university-logo { max-width: 80px; height: auto; }
        .disabled\:bg-gray-400:disabled { background-color: #9ca3af; }
        .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-3xl mx-auto">
            <div class="flex items-center justify-center mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm flex items-center justify-center w-full">
                    <img id="userProfilePic" class="university-logo rounded-full mr-4 hidden" alt="User Profile">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-primary-green">ระบบลงทะเบียนผู้ใช้งาน</h1>
                        <h2 class="text-lg md:text-xl text-gray-600">มหาวิทยาลัยราชภัฏ</h2>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg form-container p-6 md:p-8">
                <form id="registrationForm" class="space-y-6">
                    <input type="hidden" id="userId" name="userId">
                    <input type="hidden" id="pictureUrl" name="pictureUrl">

                    <div class="grid grid-cols-1">
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อ-นามสกุล <span class="text-red-500">*</span></label>
                            <input type="text" id="fullName" name="fullName" required class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                        </div>
                    </div>

                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700 mb-1">ตำแหน่ง <span class="text-red-500">*</span></label>
                        <select id="position" name="position" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
                            <option value="" disabled selected>-- เลือกตำแหน่ง --</option>
                            <option value="อาจารย์">อาจารย์</option>
                            <option value="ผู้ช่วยศาสตราจารย์">ผู้ช่วยศาสตราจารย์</option>
                            <option value="รองศาสตราจารย์">รองศาสตราจารย์</option>
                            <option value="ศาสตราจารย์">ศาสตราจารย์</option>
                            <option value="เจ้าหน้าที่บริหารงานทั่วไป">เจ้าหน้าที่บริหารงานทั่วไป</option>
                            <option value="นักวิชาการคอมพิวเตอร์">นักวิชาการคอมพิวเตอร์</option>
                            <option value="นักวิชาการศึกษา">นักวิชาการศึกษา</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="department" class="block text-sm font-medium text-gray-700 mb-1">หน่วยงาน <span class="text-red-500">*</span></label>
                            <select id="department" name="department" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                <option value="" disabled selected>-- เลือกหน่วยงาน --</option>
                                <option value="คณะครุศาสตร์">คณะครุศาสตร์</option>
                                <option value="คณะมนุษยศาสตร์และสังคมศาสตร์">คณะมนุษยศาสตร์และสังคมศาสตร์</option>
                                <option value="คณะวิทยาศาสตร์และเทคโนโลยี">คณะวิทยาศาสตร์และเทคโนโลยี</option>
                            </select>
                        </div>
                        <div>
                            <label for="location" class="block text-sm font-medium text-gray-700 mb-1">สถานที่ตั้ง <span class="text-red-500">*</span></label>
                            <select id="location" name="location" required class="w-full px-4 py-2 border border-gray-300 rounded-md">
                                <option value="" disabled selected>-- เลือกสถานที่ตั้ง --</option>
                                <option value="อาคาร 1">อาคาร 1</option>
                                <option value="อาคาร 2">อาคาร 2</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="phoneExt" class="block text-sm font-medium text-gray-700 mb-1">เบอร์โทรภายใน (4 หลัก) <span class="text-red-500">*</span></label>
                        <input type="text" id="phoneExt" name="phoneExt" required maxlength="4" pattern="[0-9]{4}" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="เช่น 1234">
                    </div>

                    <div class="flex items-start space-x-3 bg-yellow-50 p-4 rounded-md">
                        <input type="checkbox" id="pdpaConsent" name="pdpaConsent" required class="h-5 w-5 text-primary-green">
                        <label for="pdpaConsent" class="text-sm text-gray-700">
                            ข้าพเจ้ายินยอมให้มหาวิทยาลัยฯ เก็บรวบรวม ใช้ และเปิดเผยข้อมูลส่วนบุคคลของข้าพเจ้า...<span class="text-red-500">*</span>
                        </label>
                    </div>

                    <div class="flex justify-center pt-4">
                        <button type="submit" id="submitButton" disabled class="btn-submit px-8 py-3 text-white font-medium rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed">ลงทะเบียน</button>
                    </div>
                </form>

                <div id="loadingMessage" class="text-center text-gray-500 mt-4">
                    <p>กำลังโหลดข้อมูลผู้ใช้จาก LINE...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const form = document.getElementById('registrationForm');
            const submitButton = document.getElementById('submitButton');
            const loadingMessage = document.getElementById('loadingMessage');

            try {
                // !!! PASTE YOUR LIFF ID HERE !!!
                await liff.init({ liffId: "2007495650-1nWAxDD9" });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                
                // Populate Form
                document.getElementById('userId').value = profile.userId;
                document.getElementById('fullName').value = profile.displayName;
                document.getElementById('pictureUrl').value = profile.pictureUrl;
                
                const profilePic = document.getElementById('userProfilePic');
                profilePic.src = profile.pictureUrl;
                profilePic.classList.remove('hidden');

                // --- Enable form submission ---
                loadingMessage.style.display = 'none'; // Hide loading message
                submitButton.disabled = false; // Enable the submit button

            } catch (err) {
                loadingMessage.innerHTML = '<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้</p>';
                Swal.fire({
                    icon: 'error',
                    title: 'LIFF Error',
                    text: 'ไม่สามารถโหลดข้อมูลผู้ใช้จาก LINE ได้: ' + err.message,
                    allowOutsideClick: false
                });
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!form.checkValidity()) {
                    Swal.fire({ icon: 'error', title: 'กรุณากรอกข้อมูลให้ครบถ้วน' });
                    return;
                }
                
                const formData = {
                    userId: document.getElementById('userId').value,
                    fullName: document.getElementById('fullName').value,
                    pictureUrl: document.getElementById('pictureUrl').value,
                    position: document.getElementById('position').value,
                    department: document.getElementById('department').value,
                    location: document.getElementById('location').value,
                    phoneExt: document.getElementById('phoneExt').value,
                    pdpaConsent: document.getElementById('pdpaConsent').checked
                };

                if (!formData.userId) {
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: 'ไม่พบ LINE User ID กรุณาลองเปิดใหม่อีกครั้ง' });
                    return;
                }

                Swal.fire({
                    title: 'กำลังบันทึกข้อมูล',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                submitFormWithJSONP(formData);
            });
        });

        function submitFormWithJSONP(data) {
            const callbackName = 'jsonpCallback_' + Date.now();
            window[callbackName] = function(response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'บันทึกข้อมูลสำเร็จ',
                        text: 'ขอบคุณสำหรับการลงทะเบียน ท่านสามารถปิดหน้านี้ได้เลย'
                    }).then(() => {
                        liff.closeWindow();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'เกิดข้อผิดพลาด',
                        text: response.message || 'ไม่สามารถบันทึกข้อมูลได้'
                    });
                }
                delete window[callbackName];
                // A small safety check for the script element before removing
                const scriptEl = document.getElementById('jsonp-script-' + callbackName);
                if(scriptEl) {
                    document.body.removeChild(scriptEl);
                }
            };

            // !!! PASTE YOUR WEB APP URL HERE !!!
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbzc5WNqmqUVpubQ0QfFkieiJCx1ZlgWdiDJhHPj9pPpnYI4Uj0rLehc7JCSm7FYbI4v/exec'; 
            const queryParams = new URLSearchParams({
                callback: callbackName,
                action: 'registerLiff',
                ...data
            }).toString();

            const script = document.createElement('script');
            script.id = 'jsonp-script-' + callbackName;
            script.src = `${scriptUrl}?${queryParams}`;
            
            script.onerror = function() {
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาดในการเชื่อมต่อ' });
                delete window[callbackName];
            };
            
            document.body.appendChild(script);
        }
    </script>
</body>
</html>